<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gerador MAPA/Holter</title>

<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #eef2f5; }
  .header { text-align: center; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.08); margin-bottom: 20px; display:flex; justify-content:center; gap:10px; align-items:center;}
  .header input[type="date"] { padding:8px; border:1px solid #ccc; border-radius:6px; font-size:16px;}
  .header button { background:#007bff; color:#fff; border:none; border-radius:50%; width:40px; height:40px; font-size:18px; cursor:pointer;}
  .container { display: flex; gap: 20px; flex-wrap: wrap; }
  .list-section { flex: 1; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.08); min-width: 320px; }
  h2 { margin: 0 0 12px; border-bottom: 2px solid #007bff; display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; }
  .name-counter { font-size: .8em; background: #e9ecef; padding: 5px 10px; border-radius: 14px; color: #495057; }
  input[type="text"], input[type="search"] { width: 100%; padding: 8px 12px; margin-bottom: 10px; border: 1px solid #ced4da; border-radius: 6px; }
  ol { padding-left: 40px; height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding-top: 10px; padding-bottom: 10px; margin: 0 0 12px; }
  li { margin-bottom: 10px; }
  li.hidden { display: none; }
  .buttons { display:flex; flex-direction:column; gap:10px;}
  .buttons button { padding: 12px; border: 0; border-radius: 8px; font-size: 16px; color: #fff; background: #007bff; cursor: pointer;}
  .buttons button:hover { background: #0056b3; }
</style>

<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>
  <div class="header">
    <input type="date" id="schedule-date" />
    <button id="btn-today">ðŸ“…</button>
  </div>

  <div class="container">
    <div class="list-section">
      <h2>MAPA <span id="mapa-counter" class="name-counter">0/30</span></h2>
      <input type="search" id="search-mapa" placeholder="Pesquisar nome (a partir do 6Âº caractere)" />
      <ol id="mapa-list"></ol>
      <div class="buttons">
        <button id="btn-print-mapa">Imprimir MAPA</button>
        <button id="btn-save-mapa">Salvar PDF MAPA</button>
      </div>
    </div>

    <div class="list-section">
      <h2>HOLTER <span id="holter-counter" class="name-counter">0/30</span></h2>
      <input type="search" id="search-holter" placeholder="Pesquisar nome (a partir do 6Âº caractere)" />
      <ol id="holter-list"></ol>
      <div class="buttons">
        <button id="btn-print-holter">Imprimir HOLTER</button>
        <button id="btn-save-holter">Salvar PDF HOLTER</button>
      </div>
    </div>
  </div>

<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCeygrkw2tQHHYy5ocBcMBnRyYvAVXRW2g",
  authDomain: "agenda-da-val.firebaseapp.com",
  projectId: "agenda-da-val",
  storageBucket: "agenda-da-val.firebasestorage.app",
  messagingSenderId: "4483197465",
  appId: "1:4483197465:web:a31a604e5ab0a3e7021888"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window.firebase = {
  saveData: async (date, data) => { await setDoc(doc(db,"schedules",date),data); },
  loadData: async (date) => { const snap = await getDoc(doc(db,"schedules",date)); return snap.exists()?snap.data():null; }
};
</script>

<script>
const LIST_SIZE = 30;
const PDFs = { TERMO_MAPA:"tmapa.pdf", DIARIO_MAPA:"dmapa.pdf", TERMO_HOLTER:"tholter.pdf", DIARIO_HOLTER:"dholter.pdf" };

function init(){
  createList("mapa");
  createList("holter");
  setToday();
  document.getElementById("btn-today").addEventListener("click",setToday);
  document.getElementById("schedule-date").addEventListener("change",loadData);
  setTimeout(loadData,400);

  document.getElementById("btn-print-mapa").addEventListener("click",()=>generateReport("mapa",true));
  document.getElementById("btn-save-mapa").addEventListener("click",()=>generateReport("mapa",false));
  document.getElementById("btn-print-holter").addEventListener("click",()=>generateReport("holter",true));
  document.getElementById("btn-save-holter").addEventListener("click",()=>generateReport("holter",false));

  document.getElementById("search-mapa").addEventListener("input",(e)=>filterList("mapa",e.target.value));
  document.getElementById("search-holter").addEventListener("input",(e)=>filterList("holter",e.target.value));

  setInterval(saveData,10000);
}

function setToday(){
  document.getElementById("schedule-date").value = new Date().toISOString().split("T")[0];
}

function createList(type){
  const list=document.getElementById(`${type}-list`);
  for(let i=1;i<=LIST_SIZE;i++){
    const li=document.createElement("li");
    const input=document.createElement("input");
    input.type="text";input.placeholder=`Paciente ${i}`;
    input.addEventListener("input",()=>{updateCounter(type);debounceSave();});
    input.addEventListener("keydown",(e)=>{if(e.key==="Enter"){e.preventDefault();const next=li.nextElementSibling?.querySelector("input");if(next)next.focus();}});
    li.appendChild(input);list.appendChild(li);
  }
}

function updateCounter(type){
  const count=Array.from(document.querySelectorAll(`#${type}-list input`)).filter(i=>i.value.trim()!=="").length;
  document.getElementById(`${type}-counter`).textContent=`${count}/${LIST_SIZE}`;
}

function filterList(type,term){
  const items=document.querySelectorAll(`#${type}-list li`);
  term=term.trim().toLowerCase();
  items.forEach(li=>{
    const name=li.querySelector("input").value.toLowerCase();
    li.classList.toggle("hidden",(term.length>=6 && !name.includes(term)));
  });
}

let debounceTimer;
function debounceSave(){clearTimeout(debounceTimer);debounceTimer=setTimeout(saveData,500);}

async function saveData(){
  const date=document.getElementById("schedule-date").value;if(!date)return;
  const mapa=Array.from(document.querySelectorAll("#mapa-list input")).map(i=>i.value);
  const holter=Array.from(document.querySelectorAll("#holter-list input")).map(i=>i.value);
  await window.firebase.saveData(date,{mapa,holter});
}

async function loadData(){
  const date=document.getElementById("schedule-date").value;if(!date)return;
  const data=await window.firebase.loadData(date);
  ["mapa","holter"].forEach(type=>{
    const inputs=document.querySelectorAll(`#${type}-list input`);
    inputs.forEach((input,i)=>input.value=(data&&data[type]&&data[type][i])?data[type][i]:"");
    updateCounter(type);
  });
}

/* PDF */
async function generateReport(type,print){
  const names=Array.from(document.querySelectorAll(`#${type}-list input`)).map(i=>i.value.trim()).filter(Boolean);
  if(!names.length){alert("Nenhum nome preenchido");return;}

  const pdfs=(type==="mapa")?[PDFs.TERMO_MAPA,PDFs.DIARIO_MAPA]:[PDFs.TERMO_HOLTER,PDFs.DIARIO_HOLTER];
  const merged=await PDFLib.PDFDocument.create();
  const font=await merged.embedFont(PDFLib.StandardFonts.Helvetica);

  for(const name of names){
    for(const p of pdfs){
      const bytes=await fetch(p).then(r=>r.arrayBuffer());
      const src=await PDFLib.PDFDocument.load(bytes);
      const [page]=await merged.copyPages(src,[0]);
      merged.addPage(page);

      const last=merged.getPage(merged.getPageCount()-1);
      last.drawText(name.toUpperCase(),{x:100,y:500,size:14,font,color:PDFLib.rgb(0,0,0)});
    }
  }

  const final=await merged.save();
  const blob=new Blob([final],{type:"application/pdf"});
  const url=URL.createObjectURL(blob);
  if(print){
    const win=window.open(url,"_blank");
    setTimeout(()=>win.print(),1500);
  }else{
    const a=document.createElement("a");
    a.href=url;a.download=`${type}-relatorio.pdf`;
    document.body.appendChild(a);a.click();a.remove();
  }
}

init();
</script>
</body>
</html>
